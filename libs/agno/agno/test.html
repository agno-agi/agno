<!DOCTYPE html>
<html>
<head>
    <title>AgentOS WebSocket Test</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 20px; 
            background-color: #f5f7fa;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .controls {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        input {
            padding: 12px 16px;
            width: 300px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status-bar {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }
        
        .status-connected {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status-disconnected {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .status-connecting {
            background: #fef5e7;
            color: #744210;
            border: 1px solid #f6ad55;
        }
        
        .active-runs {
            background: #ebf8ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #bee3f8;
        }
        
        .run-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-family: monospace;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .run-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .run-status.running {
            background: #fef5e7;
            color: #744210;
        }
        
        .run-status.completed {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .run-status.error {
            background: #fed7d7;
            color: #742a2a;
        }
        
        #messages {
            border: 1px solid #e2e8f0;
            height: 400px;
            overflow-y: auto;
            padding: 16px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .message {
            margin: 8px 0;
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .message-time {
            color: #718096;
            font-size: 11px;
            margin-right: 8px;
        }
        
        .message-content {
            font-weight: 500;
        }
        
        .run-id {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
            color: rgba(0, 0, 0, 0.7);
        }
        
        /* Event Type Styles */
        .connected {
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            border-left-color: #38b2ac;
            color: #234e52;
        }
        
        .workflow_started {
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            border-left-color: #38b2ac;
            color: #234e52;
        }
        
        .step_started {
            background: linear-gradient(135deg, #fefcbf 0%, #faf089 100%);
            border-left-color: #d69e2e;
            color: #744210;
        }
        
        .step_completed {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border-left-color: #38a169;
            color: #22543d;
        }
        
        .workflow_completed {
            background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
            border-left-color: #3182ce;
            color: #2a4365;
        }
        
        .error {
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
            border-left-color: #e53e3e;
            color: #742a2a;
        }
        
        .info {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-left-color: #718096;
            color: #2d3748;
        }
        
        .config-info {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            font-size: 12px;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ AgentOS WebSocket Test</h1>
        
        <div class="config-info">
            <strong>Configuration:</strong><br>
            ‚Ä¢ AgentOS API: http://localhost:7777<br>
            ‚Ä¢ WebSocket: ws://localhost:7777/workflows/ws<br>
            ‚Ä¢ Workflow ID: basic-workflow<br>
            ‚Ä¢ Test Agent: Basic Agent (gpt-4o)
        </div>
        
        <div class="controls">
            <input type="text" id="messageInput" placeholder="Enter your message..." value="Hello, please help me with something creative">
            <button class="btn-primary" id="startBtn" onclick="startWorkflow()">üöÄ Start Workflow</button>
            <button class="btn-secondary" onclick="pingServer()">üì° Ping</button>
            <button class="btn-secondary" onclick="clearMessages()">üóëÔ∏è Clear</button>
        </div>
        
        <div id="status" class="status-bar status-disconnected">Status: Disconnected</div>
        
        <div class="active-runs">
            <h3>Active Runs:</h3>
            <div id="activeRuns">No active runs</div>
        </div>
        
        <div id="messages"></div>
    </div>
    
    <script>
        let ws = null;
        let activeRuns = new Map(); // run_id -> {status, start_time}
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        function connect() {
            updateStatus('Connecting...', 'connecting');
            ws = new WebSocket('ws://localhost:7777/workflows/ws');
            
            ws.onopen = function(event) {
                updateStatus('Connected ‚úÖ', 'connected');
                console.log('WebSocket connected');
                reconnectAttempts = 0;
                document.getElementById('startBtn').disabled = false;
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Received:', data);
                handleMessage(data);
            };
            
            ws.onclose = function(event) {
                updateStatus('Disconnected ‚ùå', 'disconnected');
                document.getElementById('startBtn').disabled = true;
                console.log('WebSocket disconnected');
                
                // Auto-reconnect
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Attempting reconnection ${reconnectAttempts}/${maxReconnectAttempts}`);
                    setTimeout(connect, 2000 * reconnectAttempts);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateStatus('Error ‚ùå', 'disconnected');
                document.getElementById('startBtn').disabled = true;
            };
        }
        
        function updateStatus(text, status) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = `Status: ${text}`;
            statusEl.className = `status-bar status-${status}`;
        }
        
        function updateActiveRuns() {
            const activeRunsEl = document.getElementById('activeRuns');
            if (activeRuns.size === 0) {
                activeRunsEl.innerHTML = 'No active runs';
            } else {
                activeRunsEl.innerHTML = Array.from(activeRuns.entries()).map(([runId, info]) => {
                    const shortId = runId.substring(0, 8) + '...';
                    const duration = Math.round((Date.now() - info.start_time) / 1000);
                    return `
                        <div class="run-item">
                            <span>üîÑ ${shortId} (${duration}s)</span>
                            <span class="run-status ${info.status}">${info.status.toUpperCase()}</span>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function handleMessage(data) {
            const eventType = data.event || 'unknown';
            
            // Track active runs
            if (data.run_id) {
                if (eventType === 'workflow_started') {
                    activeRuns.set(data.run_id, {
                        status: 'running',
                        start_time: Date.now()
                    });
                } else if (eventType === 'workflow_completed') {
                    if (activeRuns.has(data.run_id)) {
                        activeRuns.get(data.run_id).status = 'completed';
                        // Remove after 5 seconds
                        setTimeout(() => {
                            activeRuns.delete(data.run_id);
                            updateActiveRuns();
                        }, 5000);
                    }
                } else if (eventType === 'error') {
                    if (activeRuns.has(data.run_id)) {
                        activeRuns.get(data.run_id).status = 'error';
                        // Remove after 10 seconds
                        setTimeout(() => {
                            activeRuns.delete(data.run_id);
                            updateActiveRuns();
                        }, 10000);
                    }
                }
                updateActiveRuns();
            }
            
            displayMessage(data);
        }
        
        function displayMessage(data) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            const eventType = data.event || 'unknown';
            const messageStyle = getEventStyle(eventType);
            const icon = getEventIcon(eventType);
            
            messageDiv.className = `message ${messageStyle}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const runId = data.run_id ? `<span class="run-id">${data.run_id.substring(0, 8)}...</span>` : '';
            
            let content = data.message || data.content || data.error || `${eventType} event`;
            
            // Truncate long content
            if (content.length > 200) {
                content = content.substring(0, 200) + '...';
            }
            
            messageDiv.innerHTML = `
                <span class="message-time">[${timestamp}]</span>
                <span class="message-content">${icon} ${content}</span>
                ${runId}
            `;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function getEventIcon(eventType) {
            const icons = {
                'connected': 'üîå',
                'workflow_started': 'üöÄ',
                'step_started': '‚è≥',
                'step_completed': '‚úÖ',
                'workflow_completed': 'üéâ',
                'error': '‚ùå',
                'pong': 'üèì'
            };
            return icons[eventType] || 'üìù';
        }
        
        function getEventStyle(eventType) {
            const styles = {
                'connected': 'connected',
                'workflow_started': 'workflow_started',
                'step_started': 'step_started',
                'step_completed': 'step_completed',
                'workflow_completed': 'workflow_completed',
                'error': 'error',
                'pong': 'info'
            };
            return styles[eventType] || 'info';
        }
        
        function startWorkflow() {
            const message = document.getElementById('messageInput').value;
            if (!message.trim()) {
                alert('Please enter a message');
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                const payload = {
                    action: 'start-workflow',
                    workflow_id: 'basic-workflow',
                    message: message,
                    session_id: 'session_' + Date.now()
                };
                
                console.log('Sending:', payload);
                ws.send(JSON.stringify(payload));
                
                displayMessage({
                    event: 'info',
                    message: `Sending workflow request: "${message}"`
                });
            } else {
                alert('WebSocket not connected');
            }
        }
        
        function pingServer() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action: 'ping' }));
                displayMessage({
                    event: 'info',
                    message: 'Ping sent'
                });
            } else {
                alert('WebSocket not connected');
            }
        }
        
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            activeRuns.clear();
            updateActiveRuns();
        }
        
        // Handle Enter key in input
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startWorkflow();
            }
        });
        
        // Connect on page load
        connect();
        
        // Update active runs every second
        setInterval(updateActiveRuns, 1000);
    </script>
</body>
</html>